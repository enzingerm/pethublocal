version: "3.4"
services:
#MQTT Server based off mosquitto Docker file and configuration in /default
  mqtt:
    build: mqtt
    container_name: local_mqtt
    volumes:
      - './output/mqtt:/mosquitto'
    ports:
#      - "192.168.20.241:1883:1883"
#      - "192.168.20.241:8883:8883"
      - "1883:1883"
      - "8883:8883"
#Private network called surepet to bridge between mqtt and mqtt_msgs so mosquitto_sub can subscribe to messages.
    networks:
      - local_net
#mosquitto_sub that subscribes to the topic and then writes messages to /mosquitto/msgs folder, also uses surepet network to communicate to mqtt
  msgs:
    build: msgs
    container_name: local_msgs
    depends_on:
      - mqtt
    volumes:
      - './output/msgs:/mosquitto/msgs'
#User localtime to make the mqtt_msgs container local time
      - '/etc/localtime:/etc/localtime:ro'
    networks:
      - local_net
#Flask python web server that listens on port 443 for the hub to connect to on boot, also downloads the creds on the first attempt from the cloud service.
  web:
    build: web
    container_name: local_web
    volumes:
      - './output/web:/web/creds'
    ports:
#      - "192.168.20.241:443:443"
      - "443:443"

#Surepet network used between mqtt_msgs and mqtt
networks:
  local_net:

